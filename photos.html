<!-- 
    PGH Risk & Safety - Jobsite Photo Documentation
    Three-phase photo upload system for safety documentation
    
    Features:
    - Pre-task, During-task, Post-task photo phases
    - Drag-and-drop file upload
    - Real-time image preview
    - Upload progress indicators
    - Timestamp recording for compliance
-->

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="description" content="Upload and document jobsite photos for safety compliance">
    <meta name="theme-color" content="#282828">
    <title>Jobsite Photos | PGH Risk & Safety</title>
    
    <!-- Preconnect for performance -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Bootstrap 5.3.0 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome 6 for icons -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;500;600;700&family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
    <!-- Custom CSS -->
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="loading-overlay">
        <div class="spinner-border text-light" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>

    <!-- Toast Container -->
    <div class="toast-container position-fixed top-0 end-0 p-3" id="toastContainer" aria-live="polite"></div>

    <!-- NAVIGATION BAR -->
    <nav class="navbar navbar-expand-lg navbar-dark fixed-top" id="mainNavbar" aria-label="Main navigation">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="index.html">
                <i class="fas fa-hard-hat me-2" aria-hidden="true"></i>
                <span>PGH Risk & Safety</span>
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto align-items-center">
                    <li class="nav-item">
                        <a class="nav-link" href="index.html">
                            <i class="fas fa-home me-1"></i> Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="photos.html" aria-current="page">
                            <i class="fas fa-camera me-1"></i> Photos
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="training.html">
                            <i class="fas fa-graduation-cap me-1"></i> Training
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="report.html">
                            <i class="fas fa-exclamation-triangle me-1"></i> Report
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="about.html">
                            <i class="fas fa-info-circle me-1"></i> About
                        </a>
                    </li>
                    <li class="nav-item ms-lg-3">
                        <button class="btn btn-outline-light btn-sm" id="darkModeToggle" aria-label="Toggle dark mode">
                            <i class="fas fa-moon"></i>
                        </button>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- PAGE HEADER -->
    <header class="bg-primary text-white py-5" style="background: linear-gradient(135deg, var(--primary-deep-blue, #000191) 0%, #3498db 100%);">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <span class="badge bg-white text-primary mb-3">
                        <i class="fas fa-camera me-1"></i> Photo Documentation
                    </span>
                    <h1 class="display-5 fw-bold mb-3">Jobsite Photo Upload</h1>
                    <p class="lead mb-0 opacity-75">
                        Document jobsite conditions with timestamped photos. Upload pre-task, during-task, 
                        and post-task photos to maintain comprehensive safety records.
                    </p>
                </div>
                <div class="col-lg-4 text-lg-end mt-4 mt-lg-0">
                    <div class="d-flex flex-column align-items-lg-end gap-2">
                        <span class="badge bg-success px-3 py-2">
                            <i class="fas fa-check-circle me-1"></i> OSHA Compliant
                        </span>
                        <span class="text-white-50 small">
                            <i class="fas fa-clock me-1"></i> All uploads timestamped
                        </span>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- MAIN CONTENT -->
    <main id="main-content" class="py-5">
        <div class="container">
            
            <!-- Upload Progress Overview -->
            <div class="card border-0 shadow-sm mb-5">
                <div class="card-body p-4">
                    <div class="d-flex align-items-center justify-content-between mb-3">
                        <h5 class="mb-0">
                            <i class="fas fa-tasks text-primary me-2"></i>
                            Upload Progress
                        </h5>
                        <span class="badge bg-secondary">0 of 3 complete</span>
                    </div>
                    <div class="progress" style="height: 8px;">
                        <div class="progress-bar bg-success" role="progressbar" style="width: 0%;" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
                    </div>
                    <div class="d-flex justify-content-between mt-2 small text-muted">
                        <span><i class="fas fa-flag-checkered text-success me-1"></i> Pre-Task</span>
                        <span><i class="fas fa-hard-hat text-warning me-1"></i> During-Task</span>
                        <span><i class="fas fa-clipboard-check text-primary me-1"></i> Post-Task</span>
                    </div>
                </div>
            </div>

            <div class="row g-4">
                
                <!-- PRE-TASK PHOTO SECTION -->
                <div class="col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-success text-white d-flex align-items-center">
                            <i class="fas fa-flag-checkered me-2"></i>
                            <span class="fw-semibold">Pre-Task Photo</span>
                        </div>
                        <div class="card-body p-4">
                            <p class="text-muted small mb-3">
                                Capture conditions before work begins. Document hazards, equipment setup, and site preparation.
                            </p>
                            
                            <form id="photoUploadFormPre" data-phase="Pre-task">
                                <!-- Drag & Drop Zone -->
                                <div class="photo-preview-container mb-3">
                                    <img id="photoPreviewPre" class="photo-preview" alt="Pre-task photo preview" style="display: none;">
                                    <div class="upload-placeholder text-center p-4">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                        <p class="mb-1 text-muted small">Drag & drop or click to upload</p>
                                        <span class="text-muted smaller">JPG, PNG, HEIC (Max 10MB)</span>
                                    </div>
                                    <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer" accept="image/*" id="preTaskPhoto" aria-label="Upload pre-task photo">
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="upload-progress mb-3">
                                    <div class="upload-progress-bar"></div>
                                </div>
                                
                                <!-- Notes -->
                                <div class="mb-3">
                                    <label for="preTaskNotes" class="form-label small fw-medium">Notes (Optional)</label>
                                    <textarea class="form-control" id="preTaskNotes" rows="2" placeholder="Add any relevant observations..."></textarea>
                                </div>
                                
                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-success w-100">
                                    <i class="fas fa-upload me-2"></i> Submit Pre-Task Photo
                                </button>
                                
                                <!-- Timestamp Display -->
                                <div class="submission-timestamp mt-3" id="submissionTimestampPre" style="display: none;"></div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- DURING-TASK PHOTO SECTION -->
                <div class="col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header bg-warning text-dark d-flex align-items-center">
                            <i class="fas fa-hard-hat me-2"></i>
                            <span class="fw-semibold">During-Task Photo</span>
                        </div>
                        <div class="card-body p-4">
                            <p class="text-muted small mb-3">
                                Capture work in progress. Document active operations, safety measures in use, and ongoing conditions.
                            </p>
                            
                            <form id="photoUploadFormDuring" data-phase="During-task">
                                <!-- Drag & Drop Zone -->
                                <div class="photo-preview-container mb-3">
                                    <img id="photoPreviewDuring" class="photo-preview" alt="During-task photo preview" style="display: none;">
                                    <div class="upload-placeholder text-center p-4">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                        <p class="mb-1 text-muted small">Drag & drop or click to upload</p>
                                        <span class="text-muted smaller">JPG, PNG, HEIC (Max 10MB)</span>
                                    </div>
                                    <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer" accept="image/*" id="duringTaskPhoto" aria-label="Upload during-task photo">
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="upload-progress mb-3">
                                    <div class="upload-progress-bar"></div>
                                </div>
                                
                                <!-- Notes -->
                                <div class="mb-3">
                                    <label for="duringTaskNotes" class="form-label small fw-medium">Notes (Optional)</label>
                                    <textarea class="form-control" id="duringTaskNotes" rows="2" placeholder="Document any changes or issues..."></textarea>
                                </div>
                                
                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-warning w-100">
                                    <i class="fas fa-upload me-2"></i> Submit During-Task Photo
                                </button>
                                
                                <!-- Timestamp Display -->
                                <div class="submission-timestamp mt-3" id="submissionTimestampDuring" style="display: none;"></div>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- POST-TASK PHOTO SECTION -->
                <div class="col-lg-4">
                    <div class="card h-100 border-0 shadow-sm">
                        <div class="card-header text-white d-flex align-items-center" style="background-color: #3498db;">
                            <i class="fas fa-clipboard-check me-2"></i>
                            <span class="fw-semibold">Post-Task Photo</span>
                        </div>
                        <div class="card-body p-4">
                            <p class="text-muted small mb-3">
                                Capture final conditions. Document completed work, site cleanup, and restored safety conditions.
                            </p>
                            
                            <form id="photoUploadFormPost" data-phase="Post-task">
                                <!-- Drag & Drop Zone -->
                                <div class="photo-preview-container mb-3">
                                    <img id="photoPreviewPost" class="photo-preview" alt="Post-task photo preview" style="display: none;">
                                    <div class="upload-placeholder text-center p-4">
                                        <i class="fas fa-cloud-upload-alt fa-3x text-muted mb-2"></i>
                                        <p class="mb-1 text-muted small">Drag & drop or click to upload</p>
                                        <span class="text-muted smaller">JPG, PNG, HEIC (Max 10MB)</span>
                                    </div>
                                    <input type="file" class="position-absolute top-0 start-0 w-100 h-100 opacity-0 cursor-pointer" accept="image/*" id="postTaskPhoto" aria-label="Upload post-task photo">
                                </div>
                                
                                <!-- Progress Bar -->
                                <div class="upload-progress mb-3">
                                    <div class="upload-progress-bar"></div>
                                </div>
                                
                                <!-- Notes -->
                                <div class="mb-3">
                                    <label for="postTaskNotes" class="form-label small fw-medium">Notes (Optional)</label>
                                    <textarea class="form-control" id="postTaskNotes" rows="2" placeholder="Final observations and cleanup notes..."></textarea>
                                </div>
                                
                                <!-- Submit Button -->
                                <button type="submit" class="btn btn-info w-100 text-white">
                                    <i class="fas fa-upload me-2"></i> Submit Post-Task Photo
                                </button>
                                
                                <!-- Timestamp Display -->
                                <div class="submission-timestamp mt-3" id="submissionTimestampPost" style="display: none;"></div>
                            </form>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Photo Guidelines -->
            <div class="card border-0 shadow-sm mt-5">
                <div class="card-header bg-light border-0">
                    <h5 class="mb-0">
                        <i class="fas fa-info-circle text-primary me-2"></i>
                        Photo Guidelines
                    </h5>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-success-soft text-success rounded-circle p-2 me-3">
                                        <i class="fas fa-check"></i>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="fw-semibold">Clear & Well-Lit</h6>
                                    <p class="text-muted small mb-0">Ensure photos are clear, well-lit, and show the full area of concern.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-warning-soft text-warning rounded-circle p-2 me-3">
                                        <i class="fas fa-location-dot"></i>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="fw-semibold">Include Context</h6>
                                    <p class="text-muted small mb-0">Capture surrounding area for context. Include equipment and workers if relevant.</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="d-flex align-items-start">
                                <div class="flex-shrink-0">
                                    <div class="bg-primary-soft text-primary rounded-circle p-2 me-3">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                </div>
                                <div>
                                    <h6 class="fw-semibold">Timestamp Accuracy</h6>
                                    <p class="text-muted small mb-0">Uploads are automatically timestamped for compliance documentation.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>
    </main>

    <!-- FOOTER -->
    <footer class="footer bg-dark text-white pt-5 pb-4">
        <div class="container">
            <div class="row g-4">
                <div class="col-lg-4 mb-4">
                    <div class="footer-brand d-flex align-items-center mb-3">
                        <i class="fas fa-hard-hat me-2 text-warning fa-lg"></i>
                        <span class="h5 mb-0">PGH Risk & Safety</span>
                    </div>
                    <p class="text-muted small">
                        Professional safety management solutions for construction and industrial sites.
                    </p>
                </div>
                <div class="col-6 col-lg-2">
                    <h6 class="text-uppercase mb-3">Quick Links</h6>
                    <ul class="list-unstyled footer-links">
                        <li><a href="index.html">Dashboard</a></li>
                        <li><a href="photos.html">Photos</a></li>
                        <li><a href="training.html">Training</a></li>
                        <li><a href="report.html">Reports</a></li>
                    </ul>
                </div>
                <div class="col-6 col-lg-2">
                    <h6 class="text-uppercase mb-3">Resources</h6>
                    <ul class="list-unstyled footer-links">
                        <li><a href="#">OSHA Guidelines</a></li>
                        <li><a href="#">Safety Manual</a></li>
                        <li><a href="about.html">Contact</a></li>
                    </ul>
                </div>
                <div class="col-lg-4">
                    <h6 class="text-uppercase mb-3">Emergency Contact</h6>
                    <div class="emergency-contact bg-danger bg-opacity-10 rounded p-3">
                        <p class="mb-2 small">
                            <i class="fas fa-phone-alt me-2 text-danger"></i>
                            <strong>Safety Officer:</strong> (555) 123-4567
                        </p>
                        <p class="mb-0 small">
                            <i class="fas fa-ambulance me-2 text-danger"></i>
                            <strong>Emergency:</strong> 911
                        </p>
                    </div>
                </div>
            </div>
            <hr class="my-4 border-secondary">
            <div class="text-center">
                <p class="small text-muted mb-0">Â© 2026 PGH Risk & Safety. All rights reserved.</p>
            </div>
        </div>
    </footer>

    <!-- Back to Top Button -->
    <button id="backToTop" class="btn btn-primary btn-back-to-top shadow" aria-label="Back to top">
        <i class="fas fa-chevron-up"></i>
    </button>

    <!-- Scripts -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="js/api.js"></script>
    <script src="script.js"></script>
    <script>
        // Enhanced photo upload with API integration
        document.addEventListener('DOMContentLoaded', () => {
            initPhotoUpload();
            loadExistingPhotos();
        });
        
        function initPhotoUpload() {
            // Get all dropzones
            const dropzones = document.querySelectorAll('.dropzone');
            
            dropzones.forEach(dropzone => {
                const phase = dropzone.dataset.phase;
                const input = dropzone.querySelector('input[type="file"]');
                const preview = document.getElementById(`${phase}Preview`);
                
                // Drag and drop events
                dropzone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropzone.classList.add('dragover');
                });
                
                dropzone.addEventListener('dragleave', () => {
                    dropzone.classList.remove('dragover');
                });
                
                dropzone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropzone.classList.remove('dragover');
                    const files = e.dataTransfer.files;
                    if (files.length) {
                        handleFiles(files, phase, preview);
                    }
                });
                
                // File input change
                input?.addEventListener('change', (e) => {
                    const files = e.target.files;
                    if (files.length) {
                        handleFiles(files, phase, preview);
                    }
                });
            });
        }
        
        async function handleFiles(files, phase, previewContainer) {
            for (const file of files) {
                if (!file.type.startsWith('image/')) {
                    showToast('Only image files are allowed.', 'warning');
                    continue;
                }
                
                // Create preview element
                const previewItem = createPreviewItem(file, phase);
                previewContainer.appendChild(previewItem);
                
                // Upload file
                await uploadPhoto(file, phase, previewItem);
            }
        }
        
        function createPreviewItem(file, phase) {
            const div = document.createElement('div');
            div.className = 'photo-preview-item position-relative';
            div.innerHTML = `
                <div class="upload-progress">
                    <div class="spinner-border spinner-border-sm text-primary" role="status">
                        <span class="visually-hidden">Uploading...</span>
                    </div>
                </div>
                <img src="${URL.createObjectURL(file)}" alt="Preview" class="img-fluid rounded">
                <div class="photo-overlay">
                    <span class="badge bg-${phase === 'pre' ? 'primary' : phase === 'during' ? 'warning' : 'success'}">${phase.toUpperCase()}</span>
                </div>
            `;
            return div;
        }
        
        async function uploadPhoto(file, phase, previewItem) {
            const progressDiv = previewItem.querySelector('.upload-progress');
            
            try {
                // Check if API is available and user is authenticated
                if (typeof API !== 'undefined' && API.auth.isAuthenticated()) {
                    const result = await API.photos.upload(file, {
                        phase: phase,
                        description: `${phase.charAt(0).toUpperCase() + phase.slice(1)}-task photo`
                    });
                    
                    previewItem.dataset.photoId = result.id;
                    progressDiv.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    showToast('Photo uploaded successfully!', 'success');
                } else {
                    // Demo mode
                    await new Promise(resolve => setTimeout(resolve, 1000));
                    progressDiv.innerHTML = '<i class="fas fa-check-circle text-success"></i>';
                    showToast('Photo added! (Demo Mode)', 'success');
                }
                
                // Add delete button
                const deleteBtn = document.createElement('button');
                deleteBtn.className = 'btn btn-sm btn-danger photo-delete';
                deleteBtn.innerHTML = '<i class="fas fa-trash"></i>';
                deleteBtn.onclick = () => deletePhoto(previewItem, phase);
                previewItem.appendChild(deleteBtn);
                
            } catch (error) {
                progressDiv.innerHTML = '<i class="fas fa-times-circle text-danger"></i>';
                showToast(error.message || 'Upload failed', 'danger');
            }
        }
        
        async function deletePhoto(previewItem, phase) {
            const photoId = previewItem.dataset.photoId;
            
            if (photoId && typeof API !== 'undefined' && API.auth.isAuthenticated()) {
                try {
                    await API.photos.delete(photoId);
                } catch (error) {
                    showToast('Failed to delete photo', 'danger');
                    return;
                }
            }
            
            previewItem.remove();
            showToast('Photo removed', 'info');
        }
        
        async function loadExistingPhotos() {
            // Only load from API if authenticated
            if (typeof API === 'undefined' || !API.auth.isAuthenticated()) {
                return;
            }
            
            try {
                const response = await API.photos.getAll({ limit: 20 });
                const photos = response.photos || [];
                
                photos.forEach(photo => {
                    const phase = photo.phase || 'pre';
                    const preview = document.getElementById(`${phase}Preview`);
                    if (!preview) return;
                    
                    const div = document.createElement('div');
                    div.className = 'photo-preview-item position-relative';
                    div.dataset.photoId = photo.id;
                    div.innerHTML = `
                        <img src="/api/photos/${photo.id}/image" alt="${photo.description || 'Photo'}" class="img-fluid rounded">
                        <div class="photo-overlay">
                            <span class="badge bg-${phase === 'pre' ? 'primary' : phase === 'during' ? 'warning' : 'success'}">${phase.toUpperCase()}</span>
                        </div>
                        <button class="btn btn-sm btn-danger photo-delete" onclick="deletePhoto(this.parentElement, '${phase}')">
                            <i class="fas fa-trash"></i>
                        </button>
                    `;
                    preview.appendChild(div);
                });
                
            } catch (error) {
                console.log('Could not load existing photos:', error.message);
            }
        }
        
        function showToast(message, type = 'info') {
            const container = document.getElementById('toastContainer');
            const icons = { success: 'check-circle', danger: 'times-circle', warning: 'exclamation-triangle', info: 'info-circle' };
            
            const toast = document.createElement('div');
            toast.className = 'toast show';
            toast.innerHTML = `
                <div class="toast-header bg-${type} text-white">
                    <i class="fas fa-${icons[type]} me-2"></i>
                    <strong class="me-auto">${type === 'success' ? 'Success' : type === 'danger' ? 'Error' : 'Notice'}</strong>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="toast"></button>
                </div>
                <div class="toast-body">${message}</div>
            `;
            container.appendChild(toast);
            
            setTimeout(() => toast.remove(), 5000);
        }
    </script>
    <style>
        .photo-preview-item {
            display: inline-block;
            margin: 0.5rem;
            max-width: 150px;
        }
        .photo-preview-item img {
            width: 100%;
            height: 120px;
            object-fit: cover;
        }
        .upload-progress {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            z-index: 10;
            background: rgba(255,255,255,0.9);
            padding: 0.5rem;
            border-radius: 50%;
        }
        .photo-delete {
            position: absolute;
            top: 4px;
            right: 4px;
            padding: 0.25rem 0.4rem;
            font-size: 0.75rem;
            opacity: 0;
            transition: opacity 0.2s;
        }
        .photo-preview-item:hover .photo-delete {
            opacity: 1;
        }
        .dropzone.dragover {
            border-color: var(--bs-primary);
            background: rgba(13, 110, 253, 0.1);
        }
    </style>
</body>
</html>
